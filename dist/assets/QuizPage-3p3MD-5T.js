import{a as ee,u as se,b as te,r as n,j as e}from"./index-BxqkWTTL.js";import{a as re,g as D,d as L,b as v,j as ae,k as ie,h as ne}from"./firebaseConfig-DFE2fxb7.js";import{J as S,a as le,N as $,n as oe,O as ce,P as de,Q as me,q as A,f as ue}from"./index-BQeCGeTy.js";import{t as xe,v as he}from"./debugHelpers-DY2nFLsE.js";import{m as f}from"./proxy-Cw7Ubgne.js";import{A as ge}from"./index-B_WVIvsn.js";function ve(){const{id:b}=ee(),u=se(),U=te(),I=new URLSearchParams(U.search).get("code"),[a,M]=n.useState(null),[d,p]=n.useState(0),[o,O]=n.useState({}),[x,q]=n.useState(null),[h,z]=n.useState(!1),[H,Y]=n.useState(0),[B,G]=n.useState(!0),[C,J]=n.useState(null),[Q,k]=n.useState(null),[g,W]=n.useState(!1),[_,y]=n.useState(!1),P=t=>{const s=[...t];for(let i=s.length-1;i>0;i--){const r=Math.floor(Math.random()*(i+1));[s[i],s[r]]=[s[r],s[i]]}return s};n.useEffect(()=>{(async()=>{try{const s=L(v,"quizzes",b),i=await D(s);if(!i.exists())throw new Error("Quiz not found");const r=i.data();if(!r.questions||r.questions.length===0)throw new Error("This quiz has no questions available");const c=r.questionsToRender||r.questions.length,R=P(r.questions).slice(0,Math.min(c,r.questions.length)).map(m=>({...m,options:m.options?P(m.options):m.options}));M({...r,questions:R,originalQuestionCount:r.questions.length}),q(r.timeLimit*60)}catch(s){console.error("Quiz fetch error:",s),J(s.message||"Failed to load quiz"),setTimeout(()=>u("/student-dashboard"),3e3)}finally{G(!1)}})()},[b,u]),n.useEffect(()=>{if(!x||h||g)return;const t=setInterval(()=>{q(s=>s<=1?(clearInterval(t),E(),0):s-1)},1e3);return()=>clearInterval(t)},[x,h,g]);const K=t=>{const s=Math.floor(t/60),i=t%60;return`${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`},F=(t,s)=>{O(i=>({...i,[t]:s}))},V=()=>{!a||!a.questions||p(t=>{const s=t+1;return s<a.questions.length?s:t})},X=()=>{p(t=>t>0?t-1:0)},E=async()=>{if(!a||h)return;z(!0),k(null);let t=0;a.questions.forEach(s=>{const i=o[s.id],r=(s.options||[{id:"true",correct:!0},{id:"false",correct:!1}]).find(c=>c.correct);i===r?.id&&(t+=s.points||1)}),Y(t);try{const s=re.currentUser;if(!s)throw new Error("User not authenticated. Please log in again.");console.log("Fetching user data for:",s.uid),console.log("Current user auth data:",{uid:s.uid,email:s.email,displayName:s.displayName});const i=await D(L(v,"users",s.uid));if(!i.exists())throw new Error("User profile not found. Please contact support.");const r=i.data();if(console.log("User data retrieved from Firestore:",r),!r||!r.regNumber)throw new Error("Registration number not found in profile. Please update your profile.");const c=a.questions.length,N=c>0?Math.round(t/c*100):0,w=Math.max(0,a.timeLimit*60-(x||0)),R=xe(t,c,a.timeLimit,x),m={userId:s.uid,regNumber:r.regNumber,fullName:r.fullName||"Unknown",department:r.department||"Unknown",email:r.email||s.email||"No email provided",score:t,total:c,percentage:N,accessCode:I||"direct",submittedAt:ae(),answers:o,quizTitle:a.title,timeSpent:w};console.log("Submitting data:",m),console.log("Calculated values - Score:",t,"Total:",c,"Percentage:",N,"Time Spent:",w);const fe=he(m),Z=await ie(ne(v,"quizzes",b,"submissions"),m);console.log("Submission successful with ID:",Z.id)}catch(s){console.error("Submission error:",s),k(s.message||"Failed to submit quiz. Please try again."),z(!1)}};if(B)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex justify-center items-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-4 border-primary-500 border-t-transparent mx-auto mb-6"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-700 mb-2",children:"Loading Quiz"}),e.jsx("p",{className:"text-gray-500",children:"Please wait while we prepare your assessment..."})]})});if(C)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex justify-center items-center p-4",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"bg-red-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4",children:e.jsx(S,{className:"w-8 h-8 text-red-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Error Loading Quiz"}),e.jsx("p",{className:"text-gray-600 mb-6",children:C}),e.jsx("button",{onClick:()=>u("/student-dashboard"),className:"btn-primary",children:"Return to Dashboard"})]})});if(h)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex justify-center items-center p-4",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"bg-green-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4",children:e.jsx(le,{className:"w-8 h-8 text-green-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Quiz Submitted!"}),e.jsxs("p",{className:"text-gray-600 mb-4",children:["Your score: ",e.jsxs("span",{className:"font-semibold text-primary-600",children:[H,"/",a.questions.length]})]}),Q&&e.jsxs("div",{className:"status-error p-3 rounded-lg mb-4 text-sm",children:[e.jsx(S,{className:"inline mr-2"}),Q]}),e.jsx("button",{onClick:()=>u("/student-dashboard"),className:"btn-primary",children:"Return to Dashboard"})]})});const l=a.questions[d],j=Object.keys(o).length,T=j/a.questions.length*100;return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white shadow-soft border-b border-gray-200",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-16",children:[e.jsxs("button",{onClick:()=>u("/student-dashboard"),className:"flex items-center text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx($,{className:"w-5 h-5 mr-2"}),"Back to Dashboard"]}),e.jsxs("div",{className:"text-center flex-1",children:[e.jsx("h1",{className:"text-lg font-semibold text-gray-800 truncate",children:a.title}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Question ",d+1," of ",a.questions.length]})]})]})})}),e.jsx("div",{className:"bg-white border-b border-gray-200",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["Progress: ",j,"/",a.questions.length," answered"]}),e.jsxs("span",{className:"text-sm text-gray-500",children:[Math.round(T),"% complete"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-primary-500 h-2 rounded-full transition-all duration-300",style:{width:`${T}%`}})})]})}),e.jsx("div",{className:"bg-white border-b border-gray-200",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(oe,{className:"w-5 h-5 text-gray-500"}),e.jsx("span",{className:"text-lg font-mono font-semibold text-gray-800",children:K(x)})]}),e.jsx("button",{onClick:()=>W(!g),className:"flex items-center space-x-2 px-3 py-1 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors",children:g?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Resume"})]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Pause"})]})})]}),e.jsxs("button",{onClick:()=>y(!0),className:"flex items-center space-x-2 px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-colors",children:[e.jsx(me,{className:"w-4 h-4"}),e.jsx("span",{children:"Submit Quiz"})]})]})})}),e.jsx("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"card p-6 sm:p-8",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"flex items-start space-x-3 mb-6",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center font-semibold text-sm",children:d+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-4 leading-relaxed",children:l.question}),e.jsx("div",{className:"space-y-3",children:l.options?l.options.map((t,s)=>e.jsx(f.button,{onClick:()=>F(l.id,t.id),className:`w-full text-left p-4 rounded-lg border-2 transition-all duration-200 ${o[l.id]===t.id?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-200 hover:border-gray-300 bg-white text-gray-700"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-5 h-5 rounded-full border-2 flex items-center justify-center ${o[l.id]===t.id?"border-primary-500 bg-primary-500":"border-gray-300"}`,children:o[l.id]===t.id&&e.jsx(A,{className:"w-3 h-3 text-white"})}),e.jsx("span",{className:"font-medium",children:t.text})]})},t.id)):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[{id:"true",text:"True"},{id:"false",text:"False"}].map(t=>e.jsx(f.button,{onClick:()=>F(l.id,t.id),className:`p-4 rounded-lg border-2 transition-all duration-200 ${o[l.id]===t.id?"border-primary-500 bg-primary-50 text-primary-700":"border-gray-200 hover:border-gray-300 bg-white text-gray-700"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx("div",{className:`w-5 h-5 rounded-full border-2 flex items-center justify-center ${o[l.id]===t.id?"border-primary-500 bg-primary-500":"border-gray-300"}`,children:o[l.id]===t.id&&e.jsx(A,{className:"w-3 h-3 text-white"})}),e.jsx("span",{className:"font-medium",children:t.text})]})},t.id))})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between pt-6 border-t border-gray-200",children:[e.jsxs("button",{onClick:X,disabled:d===0,className:`flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-colors ${d===0?"text-gray-400 cursor-not-allowed":"text-gray-600 hover:text-gray-800 hover:bg-gray-100"}`,children:[e.jsx($,{className:"w-4 h-4"}),e.jsx("span",{children:"Previous"})]}),e.jsx("div",{className:"flex items-center space-x-2",children:a.questions.map((t,s)=>e.jsx("button",{onClick:()=>p(s),className:`w-3 h-3 rounded-full transition-colors ${s===d?"bg-primary-500":o[a.questions[s].id]?"bg-green-500":"bg-gray-300"}`,"aria-label":`Go to question ${s+1}`},s))}),e.jsxs("button",{onClick:V,disabled:d===a.questions.length-1,className:`flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-colors ${d===a.questions.length-1?"text-gray-400 cursor-not-allowed":"text-gray-600 hover:text-gray-800 hover:bg-gray-100"}`,children:[e.jsx("span",{children:"Next"}),e.jsx(ue,{className:"w-4 h-4"})]})]})]})}),e.jsx(ge,{children:_&&e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx(f.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"bg-white rounded-xl p-6 max-w-md w-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(S,{className:"w-6 h-6 text-yellow-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Submit Quiz?"}),e.jsxs("p",{className:"text-gray-600 mb-6",children:["You have answered ",j," out of ",a.questions.length," questions. Are you sure you want to submit your quiz?"]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>y(!1),className:"flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:()=>{y(!1),E()},className:"flex-1 px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-colors",children:"Submit Quiz"})]})]})})})})]})}export{ve as default};
