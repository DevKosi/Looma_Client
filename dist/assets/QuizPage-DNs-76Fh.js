import{a as ee,u as se,b as te,r as n,j as e}from"./index-Cd8QKmag.js";import{a as re,g as R,d as D,b as v,j as ae,k as ie,h as ne}from"./firebaseConfig-DFE2fxb7.js";import{J as S,a as oe,N as L,n as le,O as ce,P as de,Q as me,q as A,f as ue}from"./index-DquAZtMJ.js";import{t as xe,v as he}from"./debugHelpers-DY2nFLsE.js";import{m as b}from"./proxy-DIjvbQ3r.js";import{A as fe}from"./index-PX28b7nN.js";function ve(){const{id:g}=ee(),u=se(),U=te(),I=new URLSearchParams(U.search).get("code"),[a,M]=n.useState(null),[d,p]=n.useState(0),[l,O]=n.useState({}),[x,q]=n.useState(null),[h,z]=n.useState(!1),[H,Y]=n.useState(0),[B,G]=n.useState(!0),[C,J]=n.useState(null),[Q,k]=n.useState(null),[f,W]=n.useState(!1),[_,j]=n.useState(!1),P=s=>{const t=[...s];for(let i=t.length-1;i>0;i--){const r=Math.floor(Math.random()*(i+1));[t[i],t[r]]=[t[r],t[i]]}return t};n.useEffect(()=>{(async()=>{try{const t=D(v,"quizzes",g),i=await R(t);if(!i.exists())throw new Error("Quiz not found");const r=i.data();if(!r.questions||r.questions.length===0)throw new Error("This quiz has no questions available");const c=r.questionsToRender||r.questions.length,T=P(r.questions).slice(0,Math.min(c,r.questions.length)).map(m=>({...m,options:m.options?P(m.options):m.options}));M({...r,questions:T,originalQuestionCount:r.questions.length}),q(r.timeLimit*60)}catch(t){console.error("Quiz fetch error:",t),J(t.message||"Failed to load quiz"),setTimeout(()=>u("/student-dashboard"),3e3)}finally{G(!1)}})()},[g,u]),n.useEffect(()=>{if(!x||h||f)return;const s=setInterval(()=>{q(t=>t<=1?(clearInterval(s),F(),0):t-1)},1e3);return()=>clearInterval(s)},[x,h,f]);const K=s=>{const t=Math.floor(s/60),i=s%60;return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`},$=(s,t)=>{O(i=>({...i,[s]:t}))},V=()=>{!a||!a.questions||p(s=>{const t=s+1;return t<a.questions.length?t:s})},X=()=>{p(s=>s>0?s-1:0)},F=async()=>{if(!a||h)return;z(!0),k(null);let s=0;a.questions.forEach(t=>{const i=l[t.id],r=(t.options||[{id:"true",correct:!0},{id:"false",correct:!1}]).find(c=>c.correct);i===r?.id&&(s+=t.points||1)}),Y(s);try{const t=re.currentUser;if(!t)throw new Error("User not authenticated. Please log in again.");console.log("Fetching user data for:",t.uid),console.log("Current user auth data:",{uid:t.uid,email:t.email,displayName:t.displayName});const i=await R(D(v,"users",t.uid));if(!i.exists())throw new Error("User profile not found. Please contact support.");const r=i.data();if(console.log("User data retrieved from Firestore:",r),!r||!r.regNumber)throw new Error("Registration number not found in profile. Please update your profile.");const c=a.questions.length,w=c>0?Math.round(s/c*100):0,N=Math.max(0,a.timeLimit*60-(x||0)),T=xe(s,c,a.timeLimit,x),m={userId:t.uid,regNumber:r.regNumber,fullName:r.fullName||"Unknown",department:r.department||"Unknown",email:r.email||t.email||"No email provided",score:s,total:c,percentage:w,accessCode:I||"direct",submittedAt:ae(),answers:l,quizTitle:a.title,timeSpent:N};console.log("Submitting data:",m),console.log("Calculated values - Score:",s,"Total:",c,"Percentage:",w,"Time Spent:",N);const be=he(m),Z=await ie(ne(v,"quizzes",g,"submissions"),m);console.log("Submission successful with ID:",Z.id)}catch(t){console.error("Submission error:",t),k(t.message||"Failed to submit quiz. Please try again."),z(!1)}};if(B)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary-50 via-accent1-50 to-accent2-50 flex justify-center items-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-4 border-primary-500 border-t-transparent mx-auto mb-6"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Loading Quiz"}),e.jsx("p",{className:"text-gray-600",children:"Please wait while we prepare your assessment..."})]})});if(C)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-error-50 to-red-50 flex justify-center items-center p-4",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"bg-error-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4",children:e.jsx(S,{className:"w-8 h-8 text-error-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Error Loading Quiz"}),e.jsx("p",{className:"text-gray-700 mb-6",children:C}),e.jsx("button",{onClick:()=>u("/student-dashboard"),className:"btn-primary",children:"Return to Dashboard"})]})});if(h)return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-accent2-50 to-green-50 flex justify-center items-center p-4",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"bg-accent2-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4",children:e.jsx(oe,{className:"w-8 h-8 text-accent2-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Quiz Submitted!"}),e.jsxs("p",{className:"text-gray-700 mb-4",children:["Your score: ",e.jsxs("span",{className:"font-semibold text-primary-600",children:[H,"/",a.questions.length]})]}),Q&&e.jsxs("div",{className:"status-error p-3 rounded-lg mb-4 text-sm",children:[e.jsx(S,{className:"inline mr-2"}),Q]}),e.jsx("button",{onClick:()=>u("/student-dashboard"),className:"btn-primary",children:"Return to Dashboard"})]})});const o=a.questions[d],y=Object.keys(l).length,E=y/a.questions.length*100;return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-primary-50 via-accent1-50 to-accent2-50",children:[e.jsx("div",{className:"bg-white shadow-soft border-b border-primary-200",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-16",children:[e.jsxs("button",{onClick:()=>u("/student-dashboard"),className:"flex items-center text-primary-600 hover:text-primary-700 hover:bg-primary-50 px-3 py-2 rounded-lg transition-all duration-200",children:[e.jsx(L,{className:"w-5 h-5 mr-2"}),"Back to Dashboard"]}),e.jsxs("div",{className:"text-center flex-1",children:[e.jsx("h1",{className:"text-lg font-semibold text-gray-800 truncate",children:a.title}),e.jsxs("p",{className:"text-sm text-primary-600 font-medium",children:["Question ",d+1," of ",a.questions.length]})]})]})})}),e.jsx("div",{className:"bg-white border-b border-primary-200",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-primary-700",children:["Progress: ",y,"/",a.questions.length," answered"]}),e.jsxs("span",{className:"text-sm text-primary-600 font-medium",children:[Math.round(E),"% complete"]})]}),e.jsx("div",{className:"w-full bg-primary-100 rounded-full h-3",children:e.jsx("div",{className:"bg-gradient-to-r from-primary-500 to-accent1-500 h-3 rounded-full transition-all duration-500 shadow-sm",style:{width:`${E}%`}})})]})}),e.jsx("div",{className:"bg-white border-b border-primary-200",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(le,{className:"w-5 h-5 text-accent1-500"}),e.jsx("span",{className:"text-lg font-mono font-semibold text-accent1-700",children:K(x)})]}),e.jsx("button",{onClick:()=>W(!f),className:"flex items-center space-x-2 px-3 py-1 rounded-lg bg-accent1-100 hover:bg-accent1-200 text-accent1-700 transition-all duration-200",children:f?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Resume"})]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Pause"})]})})]}),e.jsxs("button",{onClick:()=>j(!0),className:"flex items-center space-x-2 px-6 py-3 bg-gradient-to-r from-primary-500 to-accent1-500 hover:from-primary-600 hover:to-accent1-600 text-white rounded-xl font-semibold transition-all duration-200 shadow-lg hover:shadow-xl",children:[e.jsx(me,{className:"w-4 h-4"}),e.jsx("span",{children:"Submit Quiz"})]})]})})}),e.jsx("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"card p-6 sm:p-8",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"flex items-start space-x-3 mb-6",children:[e.jsx("div",{className:"flex-shrink-0 w-10 h-10 bg-gradient-to-br from-primary-500 to-accent1-500 text-white rounded-full flex items-center justify-center font-bold text-sm shadow-md",children:d+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-4 leading-relaxed",children:o.question}),e.jsx("div",{className:"space-y-3",children:o.options?o.options.map((s,t)=>e.jsx(b.button,{onClick:()=>$(o.id,s.id),className:`w-full text-left p-4 rounded-xl border-2 transition-all duration-300 shadow-sm ${l[o.id]===s.id?"border-primary-500 bg-gradient-to-r from-primary-50 to-accent1-50 text-primary-700 shadow-md":"border-gray-200 hover:border-primary-300 hover:bg-primary-25 bg-white text-gray-700 hover:shadow-md"}`,whileHover:{scale:1.02,y:-2},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-200 ${l[o.id]===s.id?"border-primary-500 bg-primary-500 shadow-sm":"border-gray-300"}`,children:l[o.id]===s.id&&e.jsx(A,{className:"w-3 h-3 text-white"})}),e.jsx("span",{className:"font-medium",children:s.text})]})},s.id)):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[{id:"true",text:"True",color:"accent2"},{id:"false",text:"False",color:"error"}].map(s=>e.jsx(b.button,{onClick:()=>$(o.id,s.id),className:`p-4 rounded-xl border-2 transition-all duration-300 shadow-sm ${l[o.id]===s.id?`border-${s.color}-500 bg-gradient-to-r from-${s.color}-50 to-${s.color}-100 text-${s.color}-700 shadow-md`:`border-gray-200 hover:border-${s.color}-300 hover:bg-${s.color}-25 bg-white text-gray-700 hover:shadow-md`}`,whileHover:{scale:1.02,y:-2},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx("div",{className:`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-200 ${l[o.id]===s.id?`border-${s.color}-500 bg-${s.color}-500 shadow-sm`:"border-gray-300"}`,children:l[o.id]===s.id&&e.jsx(A,{className:"w-3 h-3 text-white"})}),e.jsx("span",{className:"font-medium",children:s.text})]})},s.id))})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between pt-6 border-t border-primary-200",children:[e.jsxs("button",{onClick:X,disabled:d===0,className:`flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 ${d===0?"text-gray-400 cursor-not-allowed":"text-primary-600 hover:text-primary-700 hover:bg-primary-50"}`,children:[e.jsx(L,{className:"w-4 h-4"}),e.jsx("span",{children:"Previous"})]}),e.jsx("div",{className:"flex items-center space-x-2",children:a.questions.map((s,t)=>e.jsx("button",{onClick:()=>p(t),className:`w-4 h-4 rounded-full transition-all duration-200 shadow-sm ${t===d?"bg-gradient-to-r from-primary-500 to-accent1-500 shadow-md":l[a.questions[t].id]?"bg-gradient-to-r from-accent2-500 to-green-500 shadow-md":"bg-gray-300 hover:bg-gray-400"}`,"aria-label":`Go to question ${t+1}`},t))}),e.jsxs("button",{onClick:V,disabled:d===a.questions.length-1,className:`flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 ${d===a.questions.length-1?"text-gray-400 cursor-not-allowed":"text-primary-600 hover:text-primary-700 hover:bg-primary-50"}`,children:[e.jsx("span",{children:"Next"}),e.jsx(ue,{className:"w-4 h-4"})]})]})]})}),e.jsx(fe,{children:_&&e.jsx(b.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx(b.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl border border-primary-100",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-warning-100 to-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg",children:e.jsx(S,{className:"w-8 h-8 text-warning-600"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-3",children:"Submit Quiz?"}),e.jsxs("p",{className:"text-gray-700 mb-8 leading-relaxed",children:["You have answered ",e.jsx("span",{className:"font-semibold text-primary-600",children:y})," out of ",e.jsx("span",{className:"font-semibold text-primary-600",children:a.questions.length})," questions. Are you sure you want to submit your quiz?"]}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx("button",{onClick:()=>j(!1),className:"flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-all duration-200 shadow-sm",children:"Cancel"}),e.jsx("button",{onClick:()=>{j(!1),F()},className:"flex-1 px-6 py-3 bg-gradient-to-r from-primary-500 to-accent1-500 hover:from-primary-600 hover:to-accent1-600 text-white rounded-xl font-semibold transition-all duration-200 shadow-lg hover:shadow-xl",children:"Submit Quiz"})]})]})})})})]})}export{ve as default};
