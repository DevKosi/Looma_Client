import{q as w,h as R,b as z,n as O,i as D,o as v}from"./firebaseConfig-DFE2fxb7.js";const b={AVERAGE_SCORE:"average_score",TOTAL_SCORE:"total_score",QUIZ_COUNT:"quiz_count",STREAK:"streak",RECENT_PERFORMANCE:"recent_performance"},E={ALL_TIME:"all_time",THIS_MONTH:"this_month",THIS_WEEK:"this_week",TODAY:"today"},P=r=>{if(!r||!r.length)return{totalQuizzes:0,totalScore:0,averageScore:0,averagePercentage:0,highestScore:0,lowestScore:0,recentStreak:0,totalPoints:0};const l=r.map(t=>t.score||0),s=r.map(t=>t.percentage||0),c=r.length,n=l.reduce((t,e)=>t+e,0),i=n/c,g=s.reduce((t,e)=>t+e,0)/c;let u=0;const d=r.sort((t,e)=>(e.submittedAt?.toDate?.()||new Date)-(t.submittedAt?.toDate?.()||new Date));for(const t of d)if((t.percentage||0)>=70)u++;else break;const a=r.reduce((t,e)=>{const o=e.score||0,h=(e.percentage||0)>=90?5:(e.percentage||0)>=80?3:(e.percentage||0)>=70?1:0;return t+o+h},0);return{totalQuizzes:c,totalScore:n,averageScore:Math.round(i*100)/100,averagePercentage:Math.round(g*100)/100,highestScore:Math.max(...l),lowestScore:Math.min(...l),recentStreak:u,totalPoints:a}},_=(r,l)=>{if(!r||!r.length)return[];const s=new Date;let c;switch(l){case E.TODAY:c=new Date(s.getFullYear(),s.getMonth(),s.getDate());break;case E.THIS_WEEK:const n=s.getDay();c=new Date(s.getTime()-n*24*60*60*1e3),c.setHours(0,0,0,0);break;case E.THIS_MONTH:c=new Date(s.getFullYear(),s.getMonth(),1);break;default:return r}return r.filter(n=>(n.submittedAt?.toDate?.()||new Date(n.submittedAt))>=c)},N=async()=>{try{console.log("ðŸ† Fetching all submissions for leaderboard...");const r=w(R(z,"quizzes")),l=await D(r);if(l.empty)return console.log("ðŸ“Š No quizzes found"),[];const s=[],c=[];return l.docs.forEach(n=>{const i=w(R(z,"quizzes",n.id,"submissions"),v("submittedAt","desc"));c.push(D(i).then(g=>{g.docs.forEach(u=>{s.push({id:u.id,quizId:n.id,quizTitle:n.data().title,...u.data()})})}).catch(g=>{console.warn(`âš ï¸ Error fetching submissions for quiz ${n.id}:`,g)}))}),await Promise.allSettled(c),console.log(`ðŸ“Š Found ${s.length} total submissions`),s}catch(r){return console.error("âŒ Error fetching submissions:",r),[]}},T=async(r,l=b.AVERAGE_SCORE,s=E.ALL_TIME,c=50)=>{try{if(console.log(`ðŸ† Generating ${r} department leaderboard...`),!r)throw new Error("Department is required");const i=(await N()).filter(e=>e.department===r);console.log(`ðŸ“Š Found ${i.length} submissions for ${r} department`);const g=_(i,s),u={};g.forEach(e=>{const o=e.userId;u[o]||(u[o]={userId:o,regNumber:e.regNumber||"N/A",fullName:e.fullName||"Unknown User",department:e.department,email:e.email||"No email",submissions:[]}),u[o].submissions.push(e)});const d=Object.values(u).map(e=>{const o=P(e.submissions);return{...e,...o,rank:0}});let a;switch(l){case b.TOTAL_SCORE:a=d.sort((e,o)=>o.totalScore-e.totalScore);break;case b.QUIZ_COUNT:a=d.sort((e,o)=>o.totalQuizzes-e.totalQuizzes);break;case b.STREAK:a=d.sort((e,o)=>o.recentStreak-e.recentStreak);break;case b.RECENT_PERFORMANCE:a=d.sort((e,o)=>{const h=e.submissions.slice(0,5),S=o.submissions.slice(0,5),m=h.length>0?h.reduce((f,A)=>f+(A.percentage||0),0)/h.length:0;return(S.length>0?S.reduce((f,A)=>f+(A.percentage||0),0)/S.length:0)-m});break;default:a=d.sort((e,o)=>o.averagePercentage!==e.averagePercentage?o.averagePercentage-e.averagePercentage:o.totalQuizzes-e.totalQuizzes)}a.forEach((e,o)=>{e.rank=o+1});const t=a.slice(0,c);return console.log(`ðŸ… ${r} leaderboard generated: ${t.length} users`),{department:r,rankingType:l,timePeriod:s,users:t,totalParticipants:d.length,generatedAt:new Date,hasData:t.length>0}}catch(n){return console.error(`âŒ Error generating ${r} leaderboard:`,n),{department:r,rankingType:l,timePeriod:s,users:[],totalParticipants:0,generatedAt:new Date,error:n.message,hasData:!1}}},k=async(r=b.AVERAGE_SCORE,l=E.ALL_TIME,s=100)=>{try{console.log("ðŸŒ Generating global leaderboard...");const c=await N();if(c.length===0)return console.log("ðŸ“Š No submissions found for global leaderboard"),{scope:"global",rankingType:r,timePeriod:l,users:[],totalParticipants:0,generatedAt:new Date,hasData:!1};const n=_(c,l),i={};n.forEach(a=>{const t=a.userId;i[t]||(i[t]={userId:t,regNumber:a.regNumber||"N/A",fullName:a.fullName||"Unknown User",department:a.department||"Unknown",email:a.email||"No email",submissions:[]}),i[t].submissions.push(a)});const g=Object.values(i).map(a=>{const t=P(a.submissions);return{...a,...t,rank:0}});let u;switch(r){case b.TOTAL_SCORE:u=g.sort((a,t)=>t.totalScore-a.totalScore);break;case b.QUIZ_COUNT:u=g.sort((a,t)=>t.totalQuizzes-a.totalQuizzes);break;case b.STREAK:u=g.sort((a,t)=>t.recentStreak-a.recentStreak);break;case b.RECENT_PERFORMANCE:u=g.sort((a,t)=>{const e=a.submissions.slice(0,5),o=t.submissions.slice(0,5),h=e.length>0?e.reduce((m,p)=>m+(p.percentage||0),0)/e.length:0;return(o.length>0?o.reduce((m,p)=>m+(p.percentage||0),0)/o.length:0)-h});break;default:u=g.sort((a,t)=>t.averagePercentage!==a.averagePercentage?t.averagePercentage-a.averagePercentage:t.totalQuizzes-a.totalQuizzes)}u.forEach((a,t)=>{a.rank=t+1});const d=u.slice(0,s);return console.log(`ðŸŒ Global leaderboard generated: ${d.length} users`),{scope:"global",rankingType:r,timePeriod:l,users:d,totalParticipants:g.length,generatedAt:new Date,hasData:d.length>0}}catch(c){return console.error("âŒ Error generating global leaderboard:",c),{scope:"global",rankingType:r,timePeriod:l,users:[],totalParticipants:0,generatedAt:new Date,error:c.message,hasData:!1}}},I=async(r,l,s=b.AVERAGE_SCORE,c=E.ALL_TIME)=>{try{if(!r||!l)return console.warn("âš ï¸ Missing userId or department for getUserPosition"),null;const n=await T(l,s,c,1e3),i=await k(s,c,1e3),g=n.users.find(d=>d.userId===r),u=i.users.find(d=>d.userId===r);return{department:{rank:g?.rank||null,totalParticipants:n.totalParticipants,stats:g||null,hasData:n.hasData},global:{rank:u?.rank||null,totalParticipants:i.totalParticipants,stats:u||null,hasData:i.hasData}}}catch(n){return console.error("âŒ Error getting user position:",n),null}},M=(r,l=null)=>{try{const s=w(R(z,"quizzes"));return O(s,async n=>{console.log("ðŸ”„ Leaderboard data updated, regenerating...");try{const i=l?await T(l):null,g=await k();r({department:i,global:g,lastUpdated:new Date})}catch(i){console.error("âŒ Error regenerating leaderboards:",i),r({department:null,global:null,error:i.message,lastUpdated:new Date})}})}catch(s){return console.error("âŒ Error setting up leaderboard listener:",s),()=>{}}};export{b as R,E as T,k as a,T as b,P as c,I as g,M as s};
