import{a as K,u as V,b as X,r as o,j as e}from"./index--pE2Y7O1.js";import{a as Z,g as k,d as E,b as y,j as _,k as ee,h as te}from"./firebaseConfig-DFE2fxb7.js";import{G as T,o as se,l as re,L as ne,c as ae}from"./index-xssimCa8.js";import{t as oe,v as ie}from"./debugHelpers-DY2nFLsE.js";function xe(){const{id:g}=K(),m=V(),F=X(),L=new URLSearchParams(F.search).get("code"),[n,P]=o.useState(null),[u,b]=o.useState(0),[x,D]=o.useState({}),[c,w]=o.useState(null),[h,v]=o.useState(!1),[S,R]=o.useState(0),[U,M]=o.useState(!0),[q,A]=o.useState(null),[f,p]=o.useState(null),z=s=>{const t=[...s];for(let a=t.length-1;a>0;a--){const r=Math.floor(Math.random()*(a+1));[t[a],t[r]]=[t[r],t[a]]}return t};o.useEffect(()=>{(async()=>{try{const t=E(y,"quizzes",g),a=await k(t);if(!a.exists())throw new Error("Quiz not found");const r=a.data();if(!r.questions||r.questions.length===0)throw new Error("This quiz has no questions available");const i=r.questionsToRender||r.questions.length,Q=z(r.questions).slice(0,Math.min(i,r.questions.length)).map(l=>({...l,options:l.options?z(l.options):l.options}));P({...r,questions:Q,originalQuestionCount:r.questions.length}),w(r.timeLimit*60)}catch(t){console.error("Quiz fetch error:",t),A(t.message||"Failed to load quiz"),setTimeout(()=>m("/student-dashboard"),3e3)}finally{M(!1)}})()},[g,m]),o.useEffect(()=>{if(!c||h)return;const s=setInterval(()=>{w(t=>t<=1?(clearInterval(s),C(),0):t-1)},1e3);return()=>clearInterval(s)},[c,h]);const I=(s,t)=>{D(a=>({...a,[s]:t}))},O=()=>{!n||!n.questions||b(s=>{const t=s+1;return t<n.questions.length?t:s})},$=()=>{b(s=>s>0?s-1:0)},C=async()=>{if(!n||h)return;v(!0),p(null);let s=0;n.questions.forEach(t=>{const a=x[t.id],r=(t.options||[{id:"true",correct:!0},{id:"false",correct:!1}]).find(i=>i.correct);a===r?.id&&(s+=t.points||1)}),R(s);try{const t=Z.currentUser;if(!t)throw new Error("User not authenticated. Please log in again.");console.log("Fetching user data for:",t.uid),console.log("Current user auth data:",{uid:t.uid,email:t.email,displayName:t.displayName});const a=await k(E(y,"users",t.uid));if(!a.exists())throw new Error("User profile not found. Please contact support.");const r=a.data();if(console.log("User data retrieved from Firestore:",r),!r||!r.regNumber)throw new Error("Registration number not found in profile. Please update your profile.");const i=n.questions.length,j=i>0?Math.round(s/i*100):0,N=Math.max(0,n.timeLimit*60-(c||0)),Q=oe(s,i,n.timeLimit,c),l={userId:t.uid,regNumber:r.regNumber,fullName:r.fullName||"Unknown",department:r.department||"Unknown",email:r.email||t.email||"No email provided",score:s,total:i,percentage:j,accessCode:L||"direct",submittedAt:_(),answers:x,quizTitle:n.title,timeSpent:N};console.log("Submitting data:",l),console.log("Calculated values - Score:",s,"Total:",i,"Percentage:",j,"Time Spent:",N);const le=ie(l),J=await ee(te(y,"quizzes",g,"submissions"),l);console.log("Submission successful with ID:",J.id)}catch(t){console.error("Submission error:",t),p(t.message||"Failed to submit quiz. Please try again."),v(!1)}};if(U)return e.jsx("div",{className:"h-screen flex justify-center items-center bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading quiz..."})]})});if(q)return e.jsx("div",{className:"h-screen flex justify-center items-center bg-gray-50 p-6",children:e.jsxs("div",{className:"bg-white p-8 rounded-xl shadow-lg text-center max-w-md w-full",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center",children:e.jsx(T,{className:"text-red-600 text-2xl"})}),e.jsx("h1",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Quiz Error"}),e.jsx("p",{className:"text-gray-600 mb-6",children:q}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Redirecting to dashboard..."}),e.jsx("button",{onClick:()=>m("/student-dashboard"),className:"bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg",children:"Go to Dashboard"})]})});if(h&&!f)return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 p-6",children:e.jsxs("div",{className:"bg-white p-8 rounded-xl shadow-lg text-center max-w-md w-full",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx(se,{className:"text-green-600 text-2xl"})}),e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Quiz Completed!"}),e.jsxs("p",{className:"text-gray-600 mt-2 mb-2",children:["You scored ",e.jsx("span",{className:"text-blue-600 font-bold",children:S})," out of"," ",e.jsx("span",{className:"font-semibold",children:n.questions.length})]}),e.jsxs("p",{className:"text-gray-500 text-sm mb-6",children:["Percentage: ",e.jsxs("span",{className:"font-semibold",children:[Math.round(S/n.questions.length*100),"%"]})]}),e.jsx("button",{onClick:()=>m("/student-dashboard"),className:"bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg",children:"Back to Dashboard"})]})});const d=n.questions[u],B=Math.floor(c/60),G=c%60,W=c<=60?"text-red-600 animate-pulse":"text-gray-800",Y=[{id:"true",text:"True",correct:!0},{id:"false",text:"False",correct:!1}],H=d.options?.length?d.options:d.type==="boolean"?Y:[];return e.jsx("div",{className:"min-h-screen bg-gray-50 p-4 md:p-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 border-b",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-800",children:n.title}),e.jsx("p",{className:"text-gray-600",children:n.description})]}),e.jsxs("div",{className:`flex items-center bg-gray-100 px-4 py-2 rounded-lg ${W}`,children:[e.jsx(re,{className:"mr-2"}),e.jsxs("span",{className:"font-mono",children:[B.toString().padStart(2,"0"),":",G.toString().padStart(2,"0")]})]})]}),e.jsx("div",{className:"p-4 border-b flex flex-wrap gap-2",children:n.questions.map((s,t)=>e.jsx("button",{onClick:()=>b(t),className:`w-9 h-9 rounded-full flex items-center justify-center text-sm ${u===t?"bg-blue-600 text-white":x[s.id]?"bg-green-100 text-green-800":"bg-gray-200 text-gray-700"}`,children:t+1},s.id))}),f&&e.jsx("div",{className:"mx-6 mt-4 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(T,{className:"text-red-600 mr-2"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-red-800 font-medium",children:"Submission Failed"}),e.jsx("p",{className:"text-red-600 text-sm",children:f}),e.jsx("button",{onClick:()=>p(null),className:"mt-2 text-red-600 hover:text-red-800 text-sm underline",children:"Try submitting again"})]})]})}),e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-3",children:d.text}),e.jsx("div",{className:"space-y-3",children:H.map(s=>e.jsx("button",{onClick:()=>I(d.id,s.id),className:`w-full text-left p-4 rounded-lg border transition-all ${x[d.id]===s.id?"border-blue-500 bg-blue-50 shadow-inner":"border-gray-200 hover:bg-gray-100"}`,children:s.text},s.id))}),e.jsxs("div",{className:"flex justify-between mt-8",children:[e.jsxs("button",{disabled:u===0,onClick:$,className:`flex items-center px-4 py-2 rounded-lg ${u===0?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(ne,{className:"mr-2"}),"Prev"]}),u<n.questions.length-1?e.jsxs("button",{onClick:O,className:"flex items-center px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:["Next",e.jsx(ae,{className:"ml-2"})]}):e.jsx("button",{onClick:C,className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:"Submit Quiz"})]})]})]})})}export{xe as default};
