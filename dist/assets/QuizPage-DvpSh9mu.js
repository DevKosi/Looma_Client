import{b as ee,u as se,c as te,a as re,r as n,j as e}from"./index-BFBCvDAu.js";import{a as ae,g as R,d as L,b as w,j as ie,k as ne,h as le}from"./firebaseConfig-DFE2fxb7.js";import{J as v,a as oe,N as $,n as de,O as ce,P as me,Q as xe,q as A,f as ue}from"./index-B3_iZ1_I.js";import{t as ge,v as he}from"./debugHelpers-DY2nFLsE.js";import{T as ye}from"./ThemeToggle-B6gMJoOo.js";import{m as y}from"./proxy-CTbeWPSj.js";import{A as be}from"./index-Bc_yggcD.js";function ze(){const{id:b}=ee(),x=se(),U=te(),I=new URLSearchParams(U.search).get("code"),{isDark:fe}=re(),[a,M]=n.useState(null),[c,f]=n.useState(0),[o,O]=n.useState({}),[u,S]=n.useState(null),[g,q]=n.useState(!1),[H,Y]=n.useState(0),[B,G]=n.useState(!0),[z,J]=n.useState(null),[C,Q]=n.useState(null),[h,W]=n.useState(!1),[_,p]=n.useState(!1),P=t=>{const s=[...t];for(let i=s.length-1;i>0;i--){const r=Math.floor(Math.random()*(i+1));[s[i],s[r]]=[s[r],s[i]]}return s};n.useEffect(()=>{(async()=>{try{const s=L(w,"quizzes",b),i=await R(s);if(!i.exists())throw new Error("Quiz not found");const r=i.data();if(!r.questions||r.questions.length===0)throw new Error("This quiz has no questions available");const d=r.questionsToRender||r.questions.length,D=P(r.questions).slice(0,Math.min(d,r.questions.length)).map(m=>({...m,options:m.options?P(m.options):m.options}));M({...r,questions:D,originalQuestionCount:r.questions.length}),S(r.timeLimit*60)}catch(s){console.error("Quiz fetch error:",s),J(s.message||"Failed to load quiz"),setTimeout(()=>x("/student-dashboard"),3e3)}finally{G(!1)}})()},[b,x]),n.useEffect(()=>{if(!u||g||h)return;const t=setInterval(()=>{S(s=>s<=1?(clearInterval(t),F(),0):s-1)},1e3);return()=>clearInterval(t)},[u,g,h]);const K=t=>{const s=Math.floor(t/60),i=t%60;return`${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`},T=(t,s)=>{O(i=>({...i,[t]:s}))},V=()=>{!a||!a.questions||f(t=>{const s=t+1;return s<a.questions.length?s:t})},X=()=>{f(t=>t>0?t-1:0)},F=async()=>{if(!a||g)return;q(!0),Q(null);let t=0;a.questions.forEach(s=>{const i=o[s.id],r=(s.options||[{id:"true",correct:!0},{id:"false",correct:!1}]).find(d=>d.correct);i===r?.id&&(t+=s.points||1)}),Y(t);try{const s=ae.currentUser;if(!s)throw new Error("User not authenticated. Please log in again.");console.log("Fetching user data for:",s.uid),console.log("Current user auth data:",{uid:s.uid,email:s.email,displayName:s.displayName});const i=await R(L(w,"users",s.uid));if(!i.exists())throw new Error("User profile not found. Please contact support.");const r=i.data();if(console.log("User data retrieved from Firestore:",r),!r||!r.regNumber)throw new Error("Registration number not found in profile. Please update your profile.");const d=a.questions.length,N=d>0?Math.round(t/d*100):0,k=Math.max(0,a.timeLimit*60-(u||0)),D=ge(t,d,a.timeLimit,u),m={userId:s.uid,regNumber:r.regNumber,fullName:r.fullName||"Unknown",department:r.department||"Unknown",email:r.email||s.email||"No email provided",score:t,total:d,percentage:N,accessCode:I||"direct",submittedAt:ie(),answers:o,quizTitle:a.title,timeSpent:k};console.log("Submitting data:",m),console.log("Calculated values - Score:",t,"Total:",d,"Percentage:",N,"Time Spent:",k);const pe=he(m),Z=await ne(le(w,"quizzes",b,"submissions"),m);console.log("Submission successful with ID:",Z.id)}catch(s){console.error("Submission error:",s),Q(s.message||"Failed to submit quiz. Please try again."),q(!1)}};if(B)return e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex justify-center items-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-4 border-primary-500 border-t-transparent mx-auto mb-6"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2",children:"Loading Quiz"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Please wait while we prepare your assessment..."})]})});if(z)return e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex justify-center items-center p-4",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"bg-red-100 dark:bg-red-900/20 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4",children:e.jsx(v,{className:"w-8 h-8 text-red-600 dark:text-red-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2",children:"Error Loading Quiz"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:z}),e.jsx("button",{onClick:()=>x("/student-dashboard"),className:"btn-primary",children:"Return to Dashboard"})]})});if(g)return e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex justify-center items-center p-4",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("div",{className:"bg-green-100 dark:bg-green-900/20 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4",children:e.jsx(oe,{className:"w-8 h-8 text-green-600 dark:text-green-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2",children:"Quiz Submitted!"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:["Your score: ",e.jsxs("span",{className:"font-semibold text-primary-600 dark:text-primary-400",children:[H,"/",a.questions.length]})]}),C&&e.jsxs("div",{className:"status-error p-3 rounded-lg mb-4 text-sm",children:[e.jsx(v,{className:"inline mr-2"}),C]}),e.jsx("button",{onClick:()=>x("/student-dashboard"),className:"btn-primary",children:"Return to Dashboard"})]})});const l=a.questions[c],j=Object.keys(o).length,E=j/a.questions.length*100;return e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow-soft border-b border-gray-200 dark:border-gray-700",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-16",children:[e.jsxs("button",{onClick:()=>x("/student-dashboard"),className:"flex items-center text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors",children:[e.jsx($,{className:"w-5 h-5 mr-2"}),"Back to Dashboard"]}),e.jsxs("div",{className:"text-center flex-1",children:[e.jsx("h1",{className:"text-lg font-semibold text-gray-800 dark:text-gray-200 truncate",children:a.title}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Question ",c+1," of ",a.questions.length]})]}),e.jsx("div",{className:"flex items-center space-x-4",children:e.jsx(ye,{})})]})})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:["Progress: ",j,"/",a.questions.length," answered"]}),e.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:[Math.round(E),"% complete"]})]}),e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2",children:e.jsx("div",{className:"bg-primary-500 h-2 rounded-full transition-all duration-300",style:{width:`${E}%`}})})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(de,{className:"w-5 h-5 text-gray-500 dark:text-gray-400"}),e.jsx("span",{className:"text-lg font-mono font-semibold text-gray-800 dark:text-gray-200",children:K(u)})]}),e.jsx("button",{onClick:()=>W(!h),className:"flex items-center space-x-2 px-3 py-1 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",children:h?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Resume"})]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Pause"})]})})]}),e.jsxs("button",{onClick:()=>p(!0),className:"flex items-center space-x-2 px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-colors",children:[e.jsx(xe,{className:"w-4 h-4"}),e.jsx("span",{children:"Submit Quiz"})]})]})})}),e.jsx("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"card p-6 sm:p-8",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"flex items-start space-x-3 mb-6",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full flex items-center justify-center font-semibold text-sm",children:c+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4 leading-relaxed",children:l.question}),e.jsx("div",{className:"space-y-3",children:l.options?l.options.map((t,s)=>e.jsx(y.button,{onClick:()=>T(l.id,t.id),className:`w-full text-left p-4 rounded-lg border-2 transition-all duration-200 ${o[l.id]===t.id?"border-primary-500 bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-300":"border-gray-200 dark:border-gray-600 hover:border-gray-300 dark:hover:border-gray-500 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-5 h-5 rounded-full border-2 flex items-center justify-center ${o[l.id]===t.id?"border-primary-500 bg-primary-500":"border-gray-300 dark:border-gray-500"}`,children:o[l.id]===t.id&&e.jsx(A,{className:"w-3 h-3 text-white"})}),e.jsx("span",{className:"font-medium",children:t.text})]})},t.id)):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[{id:"true",text:"True"},{id:"false",text:"False"}].map(t=>e.jsx(y.button,{onClick:()=>T(l.id,t.id),className:`p-4 rounded-lg border-2 transition-all duration-200 ${o[l.id]===t.id?"border-primary-500 bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-300":"border-gray-200 dark:border-gray-600 hover:border-gray-300 dark:hover:border-gray-500 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300"}`,whileHover:{scale:1.02},whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx("div",{className:`w-5 h-5 rounded-full border-2 flex items-center justify-center ${o[l.id]===t.id?"border-primary-500 bg-primary-500":"border-gray-300 dark:border-gray-500"}`,children:o[l.id]===t.id&&e.jsx(A,{className:"w-3 h-3 text-white"})}),e.jsx("span",{className:"font-medium",children:t.text})]})},t.id))})})]})]})}),e.jsxs("div",{className:"flex items-center justify-between pt-6 border-t border-gray-200 dark:border-gray-600",children:[e.jsxs("button",{onClick:X,disabled:c===0,className:`flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-colors ${c===0?"text-gray-400 dark:text-gray-500 cursor-not-allowed":"text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"}`,children:[e.jsx($,{className:"w-4 h-4"}),e.jsx("span",{children:"Previous"})]}),e.jsx("div",{className:"flex items-center space-x-2",children:a.questions.map((t,s)=>e.jsx("button",{onClick:()=>f(s),className:`w-3 h-3 rounded-full transition-colors ${s===c?"bg-primary-500":o[a.questions[s].id]?"bg-green-500":"bg-gray-300 dark:bg-gray-600"}`,"aria-label":`Go to question ${s+1}`},s))}),e.jsxs("button",{onClick:V,disabled:c===a.questions.length-1,className:`flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-colors ${c===a.questions.length-1?"text-gray-400 dark:text-gray-500 cursor-not-allowed":"text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"}`,children:[e.jsx("span",{children:"Next"}),e.jsx(ue,{className:"w-4 h-4"})]})]})]})}),e.jsx(be,{children:_&&e.jsx(y.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx(y.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-12 h-12 bg-yellow-100 dark:bg-yellow-900/20 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(v,{className:"w-6 h-6 text-yellow-600 dark:text-yellow-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2",children:"Submit Quiz?"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:["You have answered ",j," out of ",a.questions.length," questions. Are you sure you want to submit your quiz?"]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>p(!1),className:"flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:()=>{p(!1),F()},className:"flex-1 px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-colors",children:"Submit Quiz"})]})]})})})})]})}export{ze as default};
